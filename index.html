<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Thousandth of Dirt">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Thousandth of Dirt">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>Thousandth of Dirt</title>
  








<meta name="generator" content="Hexo 5.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Thousandth of Dirt</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/29/Java-%E9%AB%98%E6%80%A7%E8%83%BD%E4%B8%8B%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/29/Java-%E9%AB%98%E6%80%A7%E8%83%BD%E4%B8%8B%E8%BD%BD/" itemprop="url">Java  高性能下载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-29T19:56:25+08:00">
                2020-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="java实现高效文件下载"><a href="#java实现高效文件下载" class="headerlink" title="java实现高效文件下载"></a>java实现高效文件下载</h1><p>本文我们介绍几种方法下载文件。从基本JAVA IO 到 NIO包，也介绍第三方库的一些方法，如Async Http Client 和 Apache Commons IO.<br>最后我们还讨论在连接断开后如何恢复下载。</p>
<h2 id="使用java-IO"><a href="#使用java-IO" class="headerlink" title="使用java IO"></a>使用java IO</h2><p>下载文件最基本的方法是java IO，使用URL类打开待下载文件的连接。为有效读取文件，我们使用openStream() 方法获取 InputStream:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedInputStream in &#x3D; new BufferedInputStream(new URL(FILE_URL).openStream())1</span><br></pre></td></tr></table></figure>

<p>当从InputStream读取文件时，强烈建议使用BufferedInputStream去包装InputStream，用于提升性能。<br>使用缓存可以提升性能。read方法每次读一个字节，每次方法调用意味着系统调用底层的文件系统。当JVM调用read()方法时，程序执行上下文将从用户模式切换到内核模式并返回。</p>
<p>从性能的角度来看，这种上下文切换非常昂贵。当我们读取大量字节时，由于涉及大量上下文切换，应用程序性能将会很差。</p>
<p>为了读取URL的字节并写至本地文件，需要使用FileOutputStream 类的write方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">try (BufferedInputStream in &#x3D; new BufferedInputStream(new URL(FILE_URL).openStream());</span><br><span class="line">  FileOutputStream fileOutputStream &#x3D; new FileOutputStream(FILE_NAME)) &#123;</span><br><span class="line">    byte dataBuffer[] &#x3D; new byte[1024];</span><br><span class="line">    int bytesRead;</span><br><span class="line">    while ((bytesRead &#x3D; in.read(dataBuffer, 0, 1024)) !&#x3D; -1) &#123;</span><br><span class="line">        fileOutputStream.write(dataBuffer, 0, bytesRead);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    &#x2F;&#x2F; handle exception</span><br><span class="line">&#125;12345678910</span><br></pre></td></tr></table></figure>

<p>使用BufferedInputStream，read方法按照我们设置缓冲器大小读取文件。示例中我们设置一次读取1024字节，所以BufferedInputStream 是必要的。</p>
<p>上述示例代码冗长，幸运的是在Java7中Files类包含处理IO操作的助手方法。可以使用File.copy()方法从InputStream中读取所有字节，然后复制至本地文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InputStream in &#x3D; new URL(FILE_URL).openStream();</span><br><span class="line">Files.copy(in, Paths.get(FILE_NAME), StandardCopyOption.REPLACE_EXISTING);12</span><br></pre></td></tr></table></figure>

<p>上述代码可以正常工作，但缺点是字节被缓冲到内存中。Java为我们提供了NIO包，它有方法在两个通道之间直接传输字节，而无需缓冲。下面我们会详细讲解。</p>
<h2 id="使用NIO"><a href="#使用NIO" class="headerlink" title="使用NIO"></a>使用NIO</h2><p>java NIO包提供了无缓冲情况下在两个通道之间直接传输字节的可能。</p>
<p>为了读来自URL的文件，需从URL流创建ReadableByteChannel ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReadableByteChannel readableByteChannel &#x3D; Channels.newChannel(url.openStream());1</span><br></pre></td></tr></table></figure>

<p>从ReadableByteChannel 读取字节将被传输至FileChannel:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream fileOutputStream &#x3D; new FileOutputStream(FILE_NAME);</span><br><span class="line">FileChannel fileChannel &#x3D; fileOutputStream.getChannel();12</span><br></pre></td></tr></table></figure>

<p>然后使用transferFrom方法，从ReadableByteChannel 类下载来自URL的字节传输到FileChannel：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileOutputStream.getChannel()</span><br><span class="line">  .transferFrom(readableByteChannel, 0, Long.MAX_VALUE);12</span><br></pre></td></tr></table></figure>

<p>transferTo() 和 transferFrom() 方法比简单使用缓存从流中读更有效。依据不同的底层操作系统，数据可以直接从文件系统缓存传输到我们的文件，而不必将任何字节复制到应用程序内存中。</p>
<p>在Linux和UNIX系统上，这些方法使用零拷贝技术，减少了内核模式和用户模式之间的上下文切换次数。</p>
<h2 id="使用第三方库"><a href="#使用第三方库" class="headerlink" title="使用第三方库"></a>使用第三方库</h2><p>上面我们已经使用java 核心功能实现从URL下载文件。当无需调整性能是，我们也可以利用第三方库轻松实现。举例，在实际场景中，需要实现异步下载，我们可以封装逻辑至Callable，下面看已有库实现。</p>
<h3 id="Async-HTTP-Client"><a href="#Async-HTTP-Client" class="headerlink" title="Async HTTP Client"></a>Async HTTP Client</h3><p>Async HTTP Client是使用Netty框架执行异步HTTP请求的流行库。我们使用它对URL文件执行GET请求并获取其内容。首先需要创建HTTP client：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AsyncHttpClient client &#x3D; Dsl.asyncHttpClient();1</span><br></pre></td></tr></table></figure>

<p>下面内容放到FileOutputStream：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream stream &#x3D; new FileOutputStream(FILE_NAME);1</span><br></pre></td></tr></table></figure>

<p>接下来，创建HTTP GET请求并注册AsyncCompletionHandler 处理器去处理下载内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">client.prepareGet(FILE_URL).execute(new AsyncCompletionHandler&lt;FileOutputStream&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public State onBodyPartReceived(HttpResponseBodyPart bodyPart) </span><br><span class="line">      throws Exception &#123;</span><br><span class="line">        stream.getChannel().write(bodyPart.getBodyByteBuffer());</span><br><span class="line">        return State.CONTINUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public FileOutputStream onCompleted(Response response) </span><br><span class="line">      throws Exception &#123;</span><br><span class="line">        return stream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)123456789101112131415</span><br></pre></td></tr></table></figure>

<p>上面我们覆盖了onBodyPartReceived() 方法。缺省实现是累加HTTP 接收块至ArrayList，这可能导致耗费高内存或下载大文件时OutOfMemory 异常。<br>代替累加每个HttpResponseBodyPart 至内存，我们使用FileChannel写字节至本地文件。getBodyByteBuffer()方法通过ByteBuffer访问bodyPart内容。ByteBuffers的优势是把内存分配到JVM堆之外，所以不会影响应用程序的内存。</p>
<h3 id="Apache-Commons-IO"><a href="#Apache-Commons-IO" class="headerlink" title="Apache Commons IO"></a>Apache Commons IO</h3><p>另一个高可用的IO操作库是Apache Commons IO。我们从其Javadoc看到FileUtils实用类，用于一般的文件操作任务。从URL下载文件，仅需一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FileUtils.copyURLToFile(</span><br><span class="line">  new URL(FILE_URL), </span><br><span class="line">  new File(FILE_NAME), </span><br><span class="line">  CONNECT_TIMEOUT, </span><br><span class="line">  READ_TIMEOUT);12345</span><br></pre></td></tr></table></figure>

<p>从性能角度看，与前面JAVA IO示例相同。底层代码使用相同的概念，从InputStream读取一些字节并将它们写入OutputStream。不同之处在于，URLConnection类在这里用于控制连接超时，这样下载就不会阻塞很长时间:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URLConnection connection &#x3D; source.openConnection();</span><br><span class="line">connection.setConnectTimeout(connectionTimeout);</span><br><span class="line">connection.setReadTimeout(readTimeout);123</span><br></pre></td></tr></table></figure>

<h2 id="恢复下载"><a href="#恢复下载" class="headerlink" title="恢复下载"></a>恢复下载</h2><p>考虑到internet连接的不确定性，失败时我们可以重新下载文件，但不是再次从字节0位置下载文件。<br>让我们重写前面的第一个示例，以添加这个功能。</p>
<p>我们首先要知道的是，我们可以使用HTTP HEAD方法从给定URL读取文件的大小，而无需实际下载它:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL url &#x3D; new URL(FILE_URL);</span><br><span class="line">HttpURLConnection httpConnection &#x3D; (HttpURLConnection) url.openConnection();</span><br><span class="line">httpConnection.setRequestMethod(&quot;HEAD&quot;);</span><br><span class="line">long removeFileSize &#x3D; httpConnection.getContentLengthLong();1234</span><br></pre></td></tr></table></figure>

<p>现在我们有了文件内容的总大小，可以检查文件是否已下载了部分内容。如果是，我们将继续从磁盘上记录的最后一个字节开始下载:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">long existingFileSize &#x3D; outputFile.length();</span><br><span class="line">if (existingFileSize &lt; fileLength) &#123;</span><br><span class="line">    httpFileConnection.setRequestProperty(</span><br><span class="line">      &quot;Range&quot;, </span><br><span class="line">      &quot;bytes&#x3D;&quot; + existingFileSize + &quot;-&quot; + fileLength</span><br><span class="line">    );</span><br><span class="line">&#125;1234567</span><br></pre></td></tr></table></figure>

<p>上述代码我们配置了URLConnection以在一定范围内请求文件内容。范围将从最后下载的字节位置开始，并以远程文件大小的字节长度为结束。</p>
<p>使用范围HEAD标识的另一种常见方法是通过设置不同的字节范围以块形式下载文件。例如，要下载2KB文件，我们可以使用范围0 - 1024和1024 - 2048。</p>
<p>与前节代码稍微不同的是设置FileOutputStream 方法append参数为true：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputStream os &#x3D; new FileOutputStream(FILE_NAME, true);1</span><br></pre></td></tr></table></figure>

<p>在我们做了这个更改之后，其余的代码与我们前面看到的代码一样。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在本文中，我们已经看到Java中从URL下载文件的几种实现方式。<br>最常见的实现是在执行读/写操作时使用缓冲区。这个实现即使对于大文件也是安全的，因为我们没有将整个文件加载到内存中。<br>我们还了解了如何使用Java NIO通道实现零拷贝下载。这很有用，因为它最小化了在读取和写入字节时执行的上下文切换的次数，并且通过使用直接缓冲区字节不会加载到应用程序内存中。另外，由于下载文件通常是通过HTTP完成的，我们也说明如何使用AsyncHttpClient库实现这一点。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/16/ss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/16/ss/" itemprop="url">ss</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-16T21:36:01+08:00">
                2020-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ss是Socket Statistics的缩写。顾名思义，ss命令可以用来获取socket统计信息，它可以显示和netstat类似的内容。ss的优势在于它能够显示更多更详细的有关TCP和连接状态的信息，而且比netstat更快速更高效。</p>
<p>当服务器的socket连接数量变得非常大时，无论是使用netstat命令还是直接cat /proc/net/tcp，执行速度都会很慢。</p>
<p>ss快的秘诀在于，它利用到了TCP协议栈中tcp_diag。tcp_diag是一个用于分析统计的模块，可以获得Linux 内核中第一手的信息，这就确保了ss的快捷高效。</p>
<h3 id="ss常见命令参数"><a href="#ss常见命令参数" class="headerlink" title="ss常见命令参数"></a>ss常见命令参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Usage: ss [ OPTIONS ]&#96;&#96;    &#96;&#96;ss [ OPTIONS ] [ FILTER ]&#96;&#96;  &#96;&#96;-h, --help      this message&#96;&#96;  &#96;&#96;-V, --version    output version information&#96;&#96;  &#96;&#96;-n, --numeric    don&#39;t resolve service names&#96;&#96;  &#96;&#96;-r, --resolve    resolve host names&#96;&#96;  &#96;&#96;-a, --all      display all sockets&#96;&#96;  &#96;&#96;-l, --listening   display listening socket&#96;&#96;  &#96;&#96;-o, --options    show timer information&#96;&#96;  &#96;&#96;-e, --extended   show detailed socket information&#96;&#96;  &#96;&#96;-m, --memory    show socket memory usage&#96;&#96;  &#96;&#96;-p, --processes   show process using socket&#96;&#96;  &#96;&#96;-i, --info      show internal TCP information&#96;&#96;  &#96;&#96;-s, --summary    show socket usage summary&#96; &#96;  &#96;&#96;-4, --ipv4     display only IP version 4 sockets&#96;&#96;  &#96;&#96;-6, --ipv6     display only IP version 6 sockets&#96;&#96;  &#96;&#96;-0, --packet display PACKET sockets&#96;&#96;  &#96;&#96;-t, --tcp      display only TCP sockets&#96;&#96;  &#96;&#96;-u, --udp      display only UDP sockets&#96;&#96;  &#96;&#96;-d, --dccp      display only DCCP sockets&#96;&#96;  &#96;&#96;-w, --raw      display only RAW sockets&#96;&#96;  &#96;&#96;-x, --unix      display only Unix domain sockets&#96;&#96;  &#96;&#96;-f, --family&#x3D;FAMILY display sockets of &#96;&#96;type&#96; &#96;FAMILY&#96; &#96;  &#96;&#96;-A, --query&#x3D;QUERY, --socket&#x3D;QUERY&#96;&#96;    &#96;&#96;QUERY :&#x3D; &#123;all|inet|tcp|udp|raw|unix|packet|netlink&#125;[,QUERY]&#96; &#96;  &#96;&#96;-D, --diag&#x3D;FILE   Dump raw information about TCP sockets to FILE&#96;&#96;  &#96;&#96;-F, --filter&#x3D;FILE  &#96;&#96;read&#96; &#96;filter information from FILE&#96;&#96;    &#96;&#96;FILTER :&#x3D; [ state TCP-STATE ] [ EXPRESSION ]</span><br></pre></td></tr></table></figure>



<h3 id="常用的命令展示"><a href="#常用的命令展示" class="headerlink" title="常用的命令展示"></a>常用的命令展示</h3><p><strong>ss -t -a</strong> 【显示TCP连接】</p>
<blockquote>
<p>-t： tcp</p>
<p> -a: all</p>
<p> -l: listening     【ss -l列出所有打开的网络连接端口】</p>
<p> -s: summary    【显示 Sockets 摘要】</p>
<p> -p: progress</p>
<p> -n: numeric     【不解析服务名称】</p>
<p> -r: resolve    【解析服务名称】</p>
<p> -m: memory    【显示内存情况】</p>
</blockquote>
<p>查看进程使用的socket</p>
<p>1、ss –pl</p>
<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223531755-1580727976.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223532170-306875155.png" alt="image"></a></p>
<p>找出打开套接字/端口应用程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -lp | &#96;&#96;grep&#96; &#96;22</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223532585-1127571363.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223533049-345723838.png" alt="image"></a></p>
<p>显示所有UDP Sockets</p>
<p>ss -u –a</p>
<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223533538-60300400.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223533999-1801145862.png" alt="image"></a></p>
<p>显示所有状态为established的SMTP连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -o state &#96;&#96;&#39;established&#39;</span><br><span class="line">ss -o state established &#96;&#96;&#39;( dport &#x3D; :smtp or sport &#x3D; :smtp )&#39;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223534470-2073446054.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223534892-658586688.png" alt="image"></a></p>
<p>列举出处于 FIN-WAIT-1状态的源端口为 80或者 443，目标网络为 193.233.7/24所有 tcp套接字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -o state FIN-WAIT-1 dst 192.168.25.100&#96;&#96;&#x2F;24</span><br></pre></td></tr></table></figure>

<p>匹配远程地址和端口号</p>
<p>ss dst 192.168.25.100</p>
<p>ss dst 192.168.25.100:50460</p>
<p>匹配本地地址和端口号</p>
<p>ss src 192.168.25.140</p>
<p>ss 和 netstat 效率对比</p>
<p>time netstat –an 【效率低】</p>
<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223535379-717602317.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223535826-1562743745.png" alt="image"></a></p>
<p>time ss  【效率高】</p>
<p><a target="_blank" rel="noopener" href="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223536249-43888315.png"><img src="https://images2018.cnblogs.com/blog/519608/201807/519608-20180706223536763-140879039.png" alt="image"></a></p>
<p>此篇文章为装载过来！</p>
<p>为者常成，行者常至 Give me five~!</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/16/Spark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/16/Spark/" itemprop="url">内存模型学习-- Container Executor task之间的关系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-16T12:11:19+08:00">
                2020-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>（分割线前的都是废话）</p>
<p>java8内存模型：</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/paddix/p/5309550.html">http://www.cnblogs.com/paddix/p/5309550.html</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/dingyingsi/p/3760447.html">http://www.cnblogs.com/dingyingsi/p/3760447.html</a></p>
<p>帖子里提到</p>
<p>5、方法区：</p>
<p>方法区也是所有线程共享。主要用于存储类的信息、常量池、方法数据、方法代码等。</p>
<p>方法区逻辑上属于堆的一部分，但是为了与堆进行区分，通常又叫“<strong>非堆</strong>”。 </p>
<p>1.7和1.8后这个方法区 没有了，被原空间取代了</p>
<p>不过元空间与永久代之间最大的区别在于：</p>
<p>元空间并不在虚拟机中，而是使用本地内存。因此，默认情况下，元空间的大小仅受本地内存限制，但可以通过以下参数来指定元空间的大小：</p>
<p>————–分割线———————————————————————————</p>
<p>那么这些jvm在yarn 和spark的内存模型上是怎么工作的？</p>
<p>其实我是想知道：</p>
<p><strong>spark on yarn下</strong><br><strong>一个yarn的Container 可以包含几个spark Executor？</strong><br><strong>还是一个Executor 下可以有多个Container ？</strong></p>
<p><strong>是一个Container 起了一个jvm，在这个jvm下执行多个task？</strong></p>
<p>一篇帖子spark架构中提到</p>
<p>传送门： <a target="_blank" rel="noopener" href="http://www.cnblogs.com/gaoxing/p/5041806.html">http://www.cnblogs.com/gaoxing/p/5041806.html</a></p>
<p>任何Spark的进程都是一个JVM进程</p>
<p><img src="https://images2015.cnblogs.com/blog/1093860/201705/1093860-20170526173224732-631745448.png" alt="img"></p>
<p> <img src="https://images2015.cnblogs.com/blog/1093860/201705/1093860-20170526173443747-1456396091.png" alt="img"></p>
<p>把其中一部分摘出来：</p>
<p>1.当运行在yarn集群上时，Yarn的ResourceMananger用来管理集群资源，集群上每个节点上的NodeManager用来管控所在节点的资源，从yarn的角度来看，每个节点看做可分配的资源池，<strong>当向ResourceManager请求资源时，它返回一些NodeManager信息，这些NodeManager将会提供execution container给你</strong>，<strong>每个execution container就是满足请求的堆大小的JVM进程</strong>，JVM进程的位置是由ResourceMananger管理的，不能自己控制，如果一个节点有64GB的内存被yarn管理（通过yarn.nodemanager.resource.memory-mb配置),当请求10个4G内存的executors时，这些executors可能运行在同一个节点上。</p>
<p>2.当在集群上执行应用时，job会被切分成stages,每个stage切分成task,每个task单独调度，<strong>可以把executor的jvm进程看做task执行池，每个executor有 spark.executor.cores / spark.task.cpus execution 个执行槽</strong></p>
<p>3.task基本上就是spark的一个工作单元，<strong>作为exector的jvm进程中的一个线程执行</strong>，这也是为什么spark的job启动时间快的原因，在jvm中启动一个线程比启动一个单独的jvm进程块（在hadoop中执行mapreduce应用会启动多个jvm进程） </p>
<p>总结：所以就是一个<strong>container对应一个\</strong>JVM进程（也就是一个**executor**）****</p>
<p>具体的每个节点下container和executor内存分配看下面的帖子</p>
<p><strong><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/YVFVRf3">http://www.tuicool.com/articles/YVFVRf3</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/15/S/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/15/S/" itemprop="url">Spark中master、worker、executor和driver的关系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-15T15:43:51+08:00">
                2020-12-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>刚刚接触Spark的时候对这些概念没有好好思考，走马观花似的扫过去了，后面碰到master、worker、executor和driver的时候，也就没想太多，最近刚刚跑通了一个spark项目，准备好好研究一下程序的运行原理，却突然发现对于master、worker、executor和driver一知半解，对这些概念没有很好地理解，实在难以深入学习spark，于是，查了一些资料，做了一些简单的记载供后面的学习使用。</p>
<p>首先说一句，master和worker是物理节点，driver和executor是进程。</p>
<h1 id="1，master和worker节点"><a href="#1，master和worker节点" class="headerlink" title="1，master和worker节点"></a>1，master和worker节点</h1><p>搭建spark集群的时候我们就已经设置好了master节点和worker节点，一个集群有多个master节点和多个worker节点。</p>
<p>master节点常驻master守护进程，负责管理worker节点，我们从master节点提交应用。</p>
<p>worker节点常驻worker守护进程，与master节点通信，并且管理executor进程。</p>
<p>PS：一台机器可以同时作为master和worker节点（举个例子：你有四台机器，你可以选择一台设置为master节点，然后剩下三台设为worker节点，也可以把四台都设为worker节点，这种情况下，有一个机器既是master节点又是worker节点）</p>
<h1 id="2，driver和executor进程"><a href="#2，driver和executor进程" class="headerlink" title="2，driver和executor进程"></a>2，driver和executor进程</h1><p>driver进程就是应用的main()函数并且构建sparkContext对象，当我们提交了应用之后，便会启动一个对应的driver进程，driver本身会根据我们设置的参数占有一定的资源（主要指cpu core和memory）。下面说一说driver和executor会做哪些事。</p>
<p>driver可以运行在master上，也可以运行worker上（根据部署模式的不同）。driver首先会向集群管理者（standalone、yarn，mesos）申请spark应用所需的资源，也就是executor，然后集群管理者会根据spark应用所设置的参数在各个worker上分配一定数量的executor，每个executor都占用一定数量的cpu和memory。在申请到应用所需的资源以后，driver就开始调度和执行我们编写的应用代码了。driver进程会将我们编写的spark应用代码拆分成多个stage，每个stage执行一部分代码片段，并为每个stage创建一批tasks，然后将这些tasks分配到各个executor中执行。</p>
<p>executor进程宿主在worker节点上，一个worker可以有多个executor。每个executor持有一个线程池，每个线程可以执行一个task，executor执行完task以后将结果返回给driver，每个executor执行的task都属于同一个应用。此外executor还有一个功能就是为应用程序中要求缓存的 RDD 提供内存式存储，RDD 是直接缓存在executor进程内的，因此任务可以在运行时充分利用缓存数据加速运算。</p>
<h1 id="3，例图"><a href="#3，例图" class="headerlink" title="3，例图"></a>3，例图</h1><p>为了加深理解，我做了一个说明图，为了便于作图，假设了一种非常简单的集群模式。</p>
<h2 id="（1）"><a href="#（1）" class="headerlink" title="（1）"></a>（1）</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://img-blog.csdnimg.cn/20181128192241304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdtb2ZhbmcxMA==,size_16,color_FFFFFF,t_70" alt="img"></h2><p>假设我们现在有一个集群，为了便于作图，我们设有一个master节点，两个worker节点，并且驱动程序运行在master节点上。</p>
<h2 id="（2）"><a href="#（2）" class="headerlink" title="（2）"></a>（2）</h2><p>​                       <img src="https://img-blog.csdnimg.cn/20181128194151526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdtb2ZhbmcxMA==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>在master节点提交应用以后，在master节点中启动driver进程，driver进程向集群管理者申请资源（executor），集群管理者在不同的worker上启动了executor进程，相当于分配资源。</p>
<h2 id="（3）"><a href="#（3）" class="headerlink" title="（3）"></a>（3）</h2><p>​                          <img src="https://img-blog.csdnimg.cn/20181128194550101.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdtb2ZhbmcxMA==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>driver进程会将我们编写的spark应用代码拆分成多个stage，每个stage执行一部分代码片段，并为每个stage创建一批tasks，然后将这些tasks分配到各个executor中执行。</p>
<p>以上大概就是spark中最基本的几个概念之一啦。这篇博文并没有涉及到具体的技术实现细节，只是一个概念上的说明，便于理解。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/13/Untitled/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/13/Untitled/" itemprop="url">控制tvOS Focus Engine</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-13T00:08:44+08:00">
                2020-12-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在iOS上，用户通常通过设备的触摸屏与您的应用互动。 但是，在tvOS上，通过在屏幕视图之间移动当前<strong>焦点</strong>来处理用户交互。</p>
<p>幸运的是，UIKit API的tvOS实现自动处理了视图之间焦点的改变。 尽管此内置系统运行良好，但对于特定的视图布局和/或目的，有时可能需要手动控制焦点引擎。</p>
<p>在本教程中，我们将深入研究tvOS焦点引擎。 您将学习它的工作原理以及如何控制它。</p>
<h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><p>本教程要求您使用最新的tvOS 9.2 SDK运行Xcode 7.3或更高版本。 如果要继续学习，还需要从<a target="_blank" rel="noopener" href="https://github.com/tutsplus/tvOS-FocusEngine-Starter">GitHub</a>下载入门项目。</p>
<h2 id="1-焦点引擎概述"><a href="#1-焦点引擎概述" class="headerlink" title="1.焦点引擎概述"></a>1.焦点引擎概述</h2><p>tvOS焦点引擎的目的是帮助开发人员专注于自己应用程序的独特内容，而不是重新实现基本的导航行为。 这意味着，尽管许多用户将使用Apple TV的Siri Remote，但焦点引擎会自动支持所有当前和将来的Apple TV输入设备。</p>
<p>这意味着，作为开发人员，您不必担心用户如何与您的应用进行交互。 焦点引擎的另一个重要目标是在应用程序之间创建一致的用户体验。 因此，没有API允许应用程序移动焦点。</p>
<h3 id="焦点运动"><a href="#焦点运动" class="headerlink" title="焦点运动"></a>焦点运动</h3><p>当用户通过沿特定方向在玻璃触摸屏上滑动而与Apple TV的遥控器进行交互时，聚焦引擎将在该方向上寻找可能的可聚焦视图，如果找到，则将焦点移至该视图。 如果找不到可聚焦的视图，则焦点将保持在当前位置。</p>
<p>除了在特定方向上移动焦点外，焦点引擎还处理其他一些更高级的行为，例如：</p>
<ul>
<li>例如，如果用户在Apple TV遥控器的Touch表面上快速滑动，则将焦点移过特定视图</li>
<li>根据焦点变化的速度运行动画</li>
<li>焦点改变时播放导航声音</li>
<li>当焦点需要移动到当前屏幕外的视图时，可为动画滚动视图的偏移自动设置动画</li>
</ul>
<p>在确定应将焦点移至应用程序中的位置时，焦点引擎会为应用程序当前界面拍摄内部图片，并突出显示所有可聚焦的可见元素。 这意味着任何隐藏的视图（包括Alpha值为0的视图）都无法聚焦。 这也意味着，对于被另一个视图隐藏的任何视图，焦点引擎仅考虑可见部分。</p>
<p>如果焦点引擎找到可以将焦点移至的视图，它将通知与更改有关的符合<code>UIFocusEnvironment</code>协议的对象。 符合<code>UIFocusEnvironment</code>协议的UIKit类为<code>UIWindow</code> ， <code>UIViewController</code> ， <code>UIView</code>和<code>UIPresentationController</code> 。 焦点引擎调用包含当前焦点视图或焦点正在移动到的视图的所有焦点环境对象的<code>shouldUpdateFocusInContext(_:)</code>方法。 如果这些方法调用中的任何一个返回<code>false</code> ，则焦点不会改变。</p>
<h3 id="最初的重点"><a href="#最初的重点" class="headerlink" title="最初的重点"></a>最初的重点</h3><p><code>UIFocusEnvironment</code>协议表示称为<strong>焦点环境</strong>的对象。 该协议定义了<code>preferredFocusView</code>属性，该属性指定当当前环境本身成为焦点时焦点应移动到的位置。</p>
<p>例如， <code>UIViewController</code>对象的默认<code>preferredFocusView</code>是其根视图。 由于每个<code>UIView</code>对象还可以指定其自己的首选焦点视图，因此可以创建<strong>首选焦点链</strong> 。 tvOS焦点引擎遵循此链，直到特定对象从其<code>preferredFocusView</code>属性返回<code>self</code>或<code>nil</code>为止。 通过使用这些属性，您可以在整个用户界面上重定向焦点，还可以指定当视图控制器出现在屏幕上时应首先聚焦哪个视图。</p>
<p>重要的是要注意，如果您不更改视图和视图控制器的任何<code>preferredFocusView</code>属性，则默认情况下，焦点引擎会将焦点集中在最靠近屏幕左上角的视图上。</p>
<h3 id="焦点更新"><a href="#焦点更新" class="headerlink" title="焦点更新"></a>焦点更新</h3><p>当发生以下三个事件之一时，就会发生焦点更新：</p>
<ul>
<li>用户引起焦点移动</li>
<li>该应用明确请求焦点更新</li>
<li>系统触发并自动更新</li>
</ul>
<p>每当进行更新时，都会发生以下事件：</p>
<ul>
<li>当前<code>UIScreen</code>对象的<code>focusedView</code>属性已更改为焦点移至的视图。</li>
<li>焦点引擎调用涉及焦点更新的每个焦点环境对象的<code>didUpdateFocusInContext(_:withAnimationCoordinator:)</code> 。 这些对象与焦点引擎通过在更新焦点之前调用每个对象的<code>shouldUpdateFocusInContext(_:)</code>方法检查的对象集合相同。 至此，您可以添加自定义动画以与系统提供的与焦点相关的动画一起运行。</li>
<li>所有协调的动画（系统动画和自定义动画）均同时运行。</li>
<li>如果焦点正在移动到的视图当前不在屏幕上并且处于滚动视图中，则系统在屏幕上滚动视图，以便用户可以看到该视图。</li>
</ul>
<p>要在用户界面中手动更新焦点，可以调用任何焦点环境对象的<code>setNeedsFocusUpdate()</code>方法。 这将重置焦点并将其移回到环境的<code>preferredFocusView</code> 。</p>
<p>该系统还可以在几种情况下触发自动焦点更新，包括当从视图层次结构中删除焦点视图，表或集合视图重新加载其数据时，或者在新视图控制器出现或关闭时。</p>
<p>尽管tvOS焦点引擎非常复杂并且有很多活动部件，但是提供给您的UIKit API使使用该系统非常容易，并且可以按您希望的方式工作。</p>
<h2 id="2-控制聚焦引擎"><a href="#2-控制聚焦引擎" class="headerlink" title="2.控制聚焦引擎"></a>2.控制聚焦引擎</h2><h3 id="重点指南"><a href="#重点指南" class="headerlink" title="重点指南"></a>重点指南</h3><p>为了扩展焦点引擎，我们将实现环绕行为。 我们当前的应用程序具有六个按钮的网格，如下面的屏幕截图所示。</p>
<p><img src="https://cms-assets.tutsplus.com/uploads/users/855/posts/26572/image/Simulator%20Screen%20Shot%2022%20May%202016,%202.45.10%20PM.jpg" alt="项目设置"></p>
<p>我们要做的是允许用户将焦点从按钮3和6向右移动，并使焦点分别回绕到按钮1和4。 由于焦点引擎会忽略任何不可见的视图，因此无法通过插入不可见的<code>UIView</code> （包括宽度和高度为0的视图）并更改其<code>preferredFocusedView</code>属性来实现。</p>
<p>相反，我们可以使用<code>UIFocusGuide</code>类完成此操作。 此类是<code>UILayoutGuide</code>的子类， <code>UILayoutGuide</code>表示屏幕上的矩形可聚焦区域，同时完全不可见并且不与视图层次结构交互。 在所有<code>UILayoutGuide</code>属性和方法的顶部， <code>UIFocusGuide</code>类添加以下属性：</p>
<ul>
<li><code>preferredFocusedView</code> ：该属性的作用与我之前所述的相同。 您可以将其视为希望焦点指南重定向到的视图。</li>
<li><code>enabled</code> ：此属性使您可以启用或禁用聚焦指南。</li>
</ul>
<p>在您的项目中，打开<strong>ViewController.swift</strong>并实现<code>ViewController</code>类的<code>viewDidAppear(_:)</code>方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">override func viewDidAppear(animated: Bool) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    super.viewDidAppear(animated)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    let rightButtonIds &#x3D; [3, 6]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    for buttonId in rightButtonIds &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if let button &#x3D; buttonWithTag(buttonId) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            let focusGuide &#x3D; UIFocusGuide()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            view.addLayoutGuide(focusGuide)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.widthAnchor.constraintEqualToAnchor(button.widthAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.heightAnchor.constraintEqualToAnchor(button.heightAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.leadingAnchor.constraintEqualToAnchor(button.trailingAnchor, constant: 60.0).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.centerYAnchor.constraintEqualToAnchor(button.centerYAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.preferredFocusedView &#x3D; buttonWithTag(buttonId-2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    let leftButtonIds &#x3D; [1, 4]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    for buttonId in leftButtonIds &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if let button &#x3D; buttonWithTag(buttonId) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            let focusGuide &#x3D; UIFocusGuide()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            view.addLayoutGuide(focusGuide)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.widthAnchor.constraintEqualToAnchor(button.widthAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.heightAnchor.constraintEqualToAnchor(button.heightAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.trailingAnchor.constraintEqualToAnchor(button.leadingAnchor, constant: -60.0).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.centerYAnchor.constraintEqualToAnchor(button.centerYAnchor).active &#x3D; true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusGuide.preferredFocusedView &#x3D; buttonWithTag(buttonId+2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>viewDidAppear(_:)</code> ，我们在按钮3和6的右侧以及按钮1的左侧创建焦点指南。  和4.由于这些聚焦指南表示用户界面中的可聚焦区域，因此它们必须具有设置的高度和宽度。 使用此代码，我们可以使区域的大小与其他按钮相同，以便聚焦引擎基于动量的逻辑与可见按钮保持一致。</p>
<h3 id="协调动画"><a href="#协调动画" class="headerlink" title="协调动画"></a>协调动画</h3><p>为了说明协调动画的工作方式，我们在焦点改变时更新了按钮的<code>alpha</code>属性。 在<strong>ViewController.swift，</strong>实现<code>didUpdateFocusInContext(_:withAnimationCoordinator:)</code>在方法<code>ViewController</code>类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">override func didUpdateFocusInContext(context: UIFocusUpdateContext, withAnimationCoordinator coordinator: UIFocusAnimationCoordinator) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    super.didUpdateFocusInContext(context, withAnimationCoordinator: coordinator)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if let focusedButton &#x3D; context.previouslyFocusedView as? UIButton where buttons.contains(focusedButton) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        coordinator.addCoordinatedAnimations(&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            focusedButton.alpha &#x3D; 0.5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, completion: &#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Run completed animation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>didUpdateFocusInContext(_:withAnimationCoordinator:)</code>的<code>context</code>参数是一个<code>UIFocusUpdateContext</code>对象，它具有以下属性：</p>
<ul>
<li><code>previouslyFocusedView</code> ：引用焦点从其移动的视图</li>
<li><code>nextFocusedView</code> ：引用焦点移至的视图</li>
<li><code>focusHeading</code> ：一个<code>UIFocusHeading</code>枚举值，表示焦点移动的方向</li>
</ul>
<p>使用<code>didUpdateFocusInContext(_:withAnimationCoordinator:)</code> ，我们添加了一个协调动画，以将先前关注的按钮的alpha值更改为0.5，将当前关注的按钮的alpha值更改为1.0。</p>
<p>在模拟器中运行该应用程序，然后在用户界面中的按钮之间移动焦点。 您可以看到当前关注的按钮的alpha为1.0，而先前关注的按钮的alpha为0.5。</p>
<p><img src="http://imgconvert.csdnimg.cn/aHR0cHM6Ly9jbXMtYXNzZXRzLnR1dHNwbHVzLmNvbS91cGxvYWRzL3VzZXJzLzg1NS9wb3N0cy8yNjU3Mi9pbWFnZS9UcmFuc3BhcmVudCUyMEJ1dHRvbnMuanBn?x-oss-process=image/format,png" alt="透明按钮"></p>
<p><code>addCoordinatedAnimations(_:completion:)</code>方法的第一个关闭与常规的<code>UIView</code>动画关闭类似。 不同之处在于它从焦点引擎继承了其持续时间和计时功能。</p>
<p>如果要运行具有自定义持续时间的动画，则可以使用<code>OverrideInheritedDuration</code>动画选项在此闭包内添加任何<code>UIView</code>动画。 以下代码是如何实现自定义动画的示例，该自定义动画的运行时间是焦点动画的一半：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Running custom timed animation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let duration &#x3D; UIView.inheritedAnimationDuration()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UIView.animateWithDuration(duration&#x2F;2.0, delay: 0.0, options: .OverrideInheritedDuration, animations: &#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Animations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;, completion: &#123; (completed: Bool) in</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Completion block</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>通过使用<code>UIFocusGuide</code>类并利用自定义动画，可以扩展tvOS焦点引擎的标准行为来满足您的需求。</p>
<h3 id="限制焦点引擎"><a href="#限制焦点引擎" class="headerlink" title="限制焦点引擎"></a>限制焦点引擎</h3><p>如前所述，在决定是否应将焦点从一个视图移动到另一个视图时，焦点引擎会在涉及的每个焦点环境上调用<code>shouldUpdateFocusInContext(_:)</code>方法。 如果这些方法调用中的任何一个返回<code>false</code> ，则焦点不会改变。</p>
<p>在我们的应用程序中，我们将在<code>ViewController</code>类中重写此方法，以便如果当前焦点位于2或3的按钮不能向下移动焦点。为此，请在<code>ViewController</code>类中实现<code>shouldUpdateFocusInContext(_:)</code> ，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">override func shouldUpdateFocusInContext(context: UIFocusUpdateContext) -&gt; Bool &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    let focusedButton &#x3D; context.previouslyFocusedView as? UIButton</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if focusedButton &#x3D;&#x3D; buttonWithTag(2) || focusedButton &#x3D;&#x3D; buttonWithTag(3) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if context.focusHeading &#x3D;&#x3D; .Down &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            return false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return super.shouldUpdateFocusInContext(context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>shouldUpdateFocusInContext(_:)</code> ，我们首先检查先前聚焦的视图是按钮2还是3。然后检查聚焦标题。 如果标题等于<code>Down</code> ，则返回<code>false</code> ，以使当前焦点不变。</p>
<p>上一次运行您的应用程序。 您不能将焦点从按钮2和3向下移动到按钮5和6。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>现在，您应该可以轻松地控制和使用tvOS的焦点引擎。 现在，您知道了焦点引擎的工作原理，以及如何对其进行调整以适应您自己的Apple TV应用程序的任何需求。</p>
<p>与往常一样，请务必在下面的评论中留下您的评论和反馈。</p>
<blockquote>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/11/%E8%AE%A9%E5%87%BACPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/11/%E8%AE%A9%E5%87%BACPU/" itemprop="url">C语言陷阱与技巧第3节，怎样主动让出CPU？如何为C语言函数增加超时检测功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-11T15:39:49+08:00">
                2020-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Linux C语言程序开发中，这个场景经常出现：进程 A 负责驱动数据采集装置获取数据，进程 B 则负责接收数据并处理。显然，进程 B 需要等待进程 A 将一次数据采集完毕才可以进行下一步工作，因此约定进程 A 采集一次数据完毕时，将 ready 位由 0 置 1，进程 B 监测 ready 位，若发现数据采集完毕，就开始数据处理。</p>
<h2 id="适时地让出-CPU"><a href="#适时地让出-CPU" class="headerlink" title="适时地让出 CPU"></a>适时地让出 CPU</h2><p><strong>如果数据到达之前，进程 B 的工作无法展开</strong>，那进程 B 显然应该时刻监测 ready 位由 0 变为 1，这样才能在数据准备完毕的<strong>第一时间</strong>开始处理数据的工作，这样的需求可以用类似下面这样的C语言代码解决，请看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!ready);</span><br><span class="line"><span class="comment">/** 下一步工作 */</span></span><br></pre></td></tr></table></figure>

<p>上面的C语言代码使用 while 循环不断检测 ready 位，一旦发现 ready 位被置 1，就立刻进行下一步的工作。这么做似乎绝对不会浪费一点点时间，因此是最好的做法。真的是这样吗？</p>
<p>如果整个系统只有进程 A 和进程 B，这么做的确很好。遗憾的是，如果系统里还有其他进程，上面这种做法就不太合适了，C语言程序遇到 while(!ready); 时，CPU 除了判断 ready 的值，其他什么都不做，这时，整个系统的效率就被拖累了。</p>
<blockquote>
<p>虽然现代操作系统大都拥有“抢占式”的内核，但一般都是通过时间片轮转调度的，在 Linux 中，调度程序的周期一般在 10ms 量级。10ms 的时间，已经够 CPU 处理很多事情了。</p>
</blockquote>
<p>如果数据的处理工作对时间的要求没有苛刻到连 10ms 都不能浪费，那么进程 B 在发现 ready 位没有被置位时，主动的将 CPU 让出给其他进程使用，显然可以提升整个系统的效率。因此，进程 B 等待 ready 置位的 C语言代码，按照下面这样写更加合适，请看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!ready)</span><br><span class="line">    usleep(<span class="number">10</span>);</span><br><span class="line"><span class="comment">/** 下一步工作 */</span></span><br></pre></td></tr></table></figure>

<p>usleep(10) 可以让进程 B 进入睡眠 10 us（微秒），但在 Linux 中，这么做能够使进程 B 将 CPU 暂时让出，交给操作系统分配给其他进程使用，进程 B 损失一点点时间效率，换来整个系统的效率提升。</p>
<h2 id="超时判断，以及-usleep-的陷阱"><a href="#超时判断，以及-usleep-的陷阱" class="headerlink" title="超时判断，以及 usleep 的陷阱"></a>超时判断，以及 usleep 的陷阱</h2><p>如果进程 A 因为某种原因退出了，那 ready 位永远都不会被置 1，这将导致进程 B 卡死在下面这两行C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!ready)</span><br><span class="line">    usleep(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>


<p>避免这种情况的一个好方法是增加<strong>超时判断</strong>，如果超过一段时间，进程 B 发现 ready 仍然没有被置位，就结束等待。要是进程 A 采集数据的周期是 t 秒，那超时时间就可以设置为 t+1 秒，这样就不会在进程 A 意外退出时，进程 B 仍然傻傻的等待 ready 位了。</p>
<p>不过，C语言并没有提供“超时”语法，这就需要程序员自己实现<strong>超时等待</strong>功能了。这种功能也并不难实现，假设超时时间为 5 秒，那相关的C语言代码可以如下实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cnt = <span class="number">50000</span>;</span><br><span class="line"><span class="keyword">while</span>(!ready &amp;&amp; cnt--)</span><br><span class="line">    usleep(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>使用上面这段C语言代码实现“超时等待”功能足够简单，但是可靠吗？假设 ready 位始终为 0，那上面这几行C语言代码就相当于下面这几行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cnt = <span class="number">50000</span>;</span><br><span class="line"><span class="keyword">while</span>(!ready &amp;&amp; cnt--)</span><br><span class="line">    usleep(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>


<p>现在在 main() 函数中测试上述方法的实际睡眠时间，相关C语言代码如下，请看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">get_cur_ms</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">     gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">     <span class="keyword">return</span> tv.tv_sec*<span class="number">1000</span> + tv.tv_usec/<span class="number">1000</span>;</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">long</span> otime = get_cur_ms();</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;cur ms: %ld\n&quot;</span>, otime);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> cnt = <span class="number">50000</span>;</span><br><span class="line">     <span class="keyword">while</span>(cnt--)</span><br><span class="line">         usleep(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;err ms: %ld\n&quot;</span>, get_cur_ms()-otime);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.popkx.com/usr/uploads/2019/03/0bdf0a656852bf55d0d623ac397ad4c3.png"><img src="https://blog.popkx.com/usr/uploads/2019/03/0bdf0a656852bf55d0d623ac397ad4c3.png" alt="img"></a><br>上述C语言代码中的 get_cur_ms() 函数可以获得当前时间的毫秒数，在测试“超时”代码之前，先使用 otime 记录当前时间 ms 数，然后在使用“超时”代码后的时间 ms 数减去 otime，就可以得到“超时”代码实际的等待时间了。编译这段C语言代码并执行，得到如下结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;a.out </span><br><span class="line">cur ms: 1553603227960</span><br><span class="line">err ms: 8406</span><br></pre></td></tr></table></figure>

<p>根据“超时”C语言代码段，预期时间差输出应该是 5 秒，也即 err ms 应该等于 5000，但是输出却是 8406，与预期相差 68%， 这是怎么回事呢？其实查看 usleep 的使用说明就可以得到答案了：<br><a target="_blank" rel="noopener" href="https://blog.popkx.com/usr/uploads/2019/03/7d233974628db2ead2a78e6f2b1e0bd3.png"><img src="https://blog.popkx.com/usr/uploads/2019/03/7d233974628db2ead2a78e6f2b1e0bd3.png" alt="img"></a><br>根据上述文档说明，usleep(usec) 会将线程挂起<strong>至少</strong> usec 秒，而不是严格的 usec 秒，具体多少时间则取决于系统的调度。如果系统比较繁忙，那么 usleep(usec) 的实际睡眠时间可能会被延长，这就解释了预期睡眠 5 秒的C语言代码，最终却睡眠了 8 秒多。</p>
<p>那“超时”代码该怎么写呢？应该明白 gettimeofday() 函数可以获取微秒量级的时间，用于“超时”估计是非常合适的，请看下面的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(get_cur_ms()-otime &lt; <span class="number">5000</span>)</span><br><span class="line">        usleep(<span class="number">100</span>); </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.popkx.com/usr/uploads/2019/03/d57f13464e46db866b00002ad77dd0b2.png"><img src="https://blog.popkx.com/usr/uploads/2019/03/d57f13464e46db866b00002ad77dd0b2.png" alt="img"></a><br>编译上述C语言代码并执行，可以得到如下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;a.out </span><br><span class="line">cur ms: 1553608462083</span><br><span class="line">err ms: 5000</span><br></pre></td></tr></table></figure>

<p>可以看出，以上C语言代码的确提供了更加精确的“超时”功能。</p>
<blockquote>
<p>感兴趣的读者可以自己掐秒表测试这两种“超时”C语言代码。</p>
</blockquote>
<h2 id="测试自定义的超时功能"><a href="#测试自定义的超时功能" class="headerlink" title="测试自定义的超时功能"></a>测试自定义的超时功能</h2><p>请看下面的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                          </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;                       </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;                         </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;                        </span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ready = <span class="number">0</span>;                              </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">get_cur_ms</span><span class="params">()</span>                           </span></span><br><span class="line"><span class="function"></span>&#123;           </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span>                      </span><br><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);                </span><br><span class="line">    <span class="keyword">return</span> tv.tv_sec*<span class="number">1000</span> + tv.tv_usec/<span class="number">1000</span>;</span><br><span class="line">&#125;           </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *p)</span>                       </span></span><br><span class="line"><span class="function"></span>&#123;           </span><br><span class="line">    sleep(<span class="number">3</span>);                               </span><br><span class="line">    ready = <span class="number">1</span>;                              </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;                            </span><br><span class="line">&#125;           </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;           </span><br><span class="line">    <span class="keyword">pthread_t</span> pid;                          </span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> otime = get_cur_ms();              </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>( !ready &amp;&amp; get_cur_ms()-otime &lt; <span class="number">5000</span>)</span><br><span class="line">        usleep(<span class="number">100</span>);                        </span><br><span class="line">    <span class="keyword">if</span>(get_cur_ms()-otime &gt;= <span class="number">5000</span>)           </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;time out\n&quot;</span>);               </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;err ms: %ld\n&quot;</span>, get_cur_ms()-otime);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.popkx.com/usr/uploads/2019/03/8e15d05d8a56df6d0a1371ea088ae553.png"><img src="https://blog.popkx.com/usr/uploads/2019/03/8e15d05d8a56df6d0a1371ea088ae553.png" alt="img"></a><br>上述C语言代码使用 thread() 线程函数模拟进程 A 对 ready 标志位 3 秒后置 1，main() 函数若 5 秒仍未检测到 ready 被置 1，就提示 “time out”。编译上述C语言代码并执行，得到如下输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># gcc t.c -lpthread</span><br><span class="line"># .&#x2F;a.out </span><br><span class="line">err ms: 3000</span><br></pre></td></tr></table></figure>

<p>因为 thread() 函数 3 秒后将 ready 置 1了，所以没有超时。现在将 thread() 中的 sleep(3) 改为 sleep(6)，编译修改后的C语言代码并执行，得到如下输出：<br><a target="_blank" rel="noopener" href="https://blog.popkx.com/usr/uploads/2019/03/13b9c701edb3c097c3be270e6802dea3.png"><img src="https://blog.popkx.com/usr/uploads/2019/03/13b9c701edb3c097c3be270e6802dea3.png" alt="img"></a><br>一切与预期一致。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>从本节可知，在 Linux C语言程序开发中，需要使用 while 循环不断检查某标志位是否置位时，若对时间的要求不是特别苛刻，可以适当调用 usleep() 函数主动让出 CPU，以提升系统的整体效率。另外，若需要增加超时功能，使用 usleep() 函数误差常常会比较大，应该借助别的方法实现。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/11/Sleep%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/11/Sleep%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" itemprop="url">Sleep的实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-11T13:25:36+08:00">
                2020-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>假设现在是 20018-12-03 12:00:00.000，如果我调用一下 Thread.Sleep(1000) ，在 20018-12-03 12:00:01.000 的时候，这个线程会不会被唤醒？</li>
<li>某人的代码中用了一句看似莫明其妙的话：Thread.Sleep(0) 。既然是 Sleep 0 毫秒，那么他跟去掉这句代码相比，有啥区别么？</li>
</ol>
<p>对于第一个问题，答案是：不一定。因为你只是告诉操作系统：在未来的1000毫秒内我不想再参与到CPU竞争。那么1000毫秒过去之后，这时候也许另外一个线程正在使用CPU，那么这时候操作系统是不会重新分配CPU的，直到那个线程挂起或结束；况且，即使这个时候恰巧轮到操作系统进行CPU 分配，那么当前线程也不一定就是总优先级最高的那个，CPU还是可能被其他线程抢占去。<br> Thread.Sleep(0)的作用，就是“让出cpu，会触发操作系统立刻重新进行一次CPU竞争”。竞争的结果也许是当前线程仍然获得CPU控制权，也许会换成别的线程获得CPU控制权。</p>
<h3 id="sleep的底层实现"><a href="#sleep的底层实现" class="headerlink" title="sleep的底层实现"></a>sleep的底层实现</h3><p>sleep()：进程、线程或任务(Linux中不区分进程与线程，都称为task)可以sleep，这会导致它们暂停执行一段时间，直到等待的时间结束才恢复执行或在这段时间内被中断。<br> sleep()在OS中的实现的大概流程：</p>
<ul>
<li>挂起进程（或线程）并修改其运行状态</li>
<li>用sleep()提供的参数来设置一个定时器。</li>
<li>当时间结束，定时器会触发，内核收到中断后修改进程（或线程）的运行状态。例如线程会被标志为就绪而进入就绪队列等待调度。</li>
</ul>
<p>可变定时器(variable timer)一般在硬件层面是通过一个固定的时钟和计数器来实现的，每经过一个时钟周期将计数器递减，当计数器的值为0时产生中断。内核注册一个定时器后可以在一段时间后收到中断。</p>
<p>alarm(time);执行之后告诉内核，让内核在time秒时间之后向该进程发送一个定时信号，然后该进程捕获该信号并处理；<br> pause()函数使该进程暂停让出CPU,但是该函数的暂停是可被中断的睡眠，也就是说收到了中断信号之后处理完毕，再重新执行该进程的时候就直接执行pause()函数之后的语句；注意的是一个进程只能有一个闹钟时间，如果调用alarm()之前已经设置了闹钟时间，那么任何以前的闹钟时间都会被新值所代替。<br> 综上所述，内核的sleep()函数是在挂起原语的基础上利用定时器实现的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F;时钟编程 alarm()</span><br><span class="line">void wakeUp()</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;please wakeup!!\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;you have 4 s sleep!\n&quot;);</span><br><span class="line">    signal(SIGALRM,wakeUp);</span><br><span class="line">    alarm(4);</span><br><span class="line">    &#x2F;&#x2F;将进程挂起</span><br><span class="line">    pause();</span><br><span class="line">    printf(&quot;good morning!\n&quot;);</span><br><span class="line"></span><br><span class="line">    return EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/11/Exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/11/Exception/" itemprop="url">RuntimeException和Exception区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-11T13:21:28+08:00">
                2020-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lulipro/p/7504267.html">1. Java中的异常和处理详解</a></p>
<p>Java设置了异常，旨在鼓励将方法中可能出现的异常告知给使用此方法的程序员（你和我！）。当然了，这种方法是<strong>比较优雅</strong>的，让我们确切的知道是在哪里出了错，并提供了异常捕获。本篇文章主要对Java中的异常进行介绍与区分。<br><img src="https://img-blog.csdnimg.cn/2019061821400045.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeHBqaXRhMzk=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这是异常的类图。</p>
<p>Throwable是Error和Exception的父类，用来定义所有可以作为异常被抛出来的类。<br>UML图如下：<br><img src="https://img-blog.csdnimg.cn/20190509163805888.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpeHBqaXRhMzk=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><h4 id="1-Error和Exception区分："><a href="#1-Error和Exception区分：" class="headerlink" title="1.Error和Exception区分："></a>1.Error和Exception区分：</h4><blockquote>
<p><strong>Error</strong>是编译时错误和系统错误，系统错误在除特殊情况下，都不需要你来关心，基本不会出现。而编译时错误，如果你使用了编译器，那么编译器会提示。</p>
</blockquote>
<blockquote>
<p><strong>Exception</strong>则是可以被抛出的基本类型，我们需要主要关心的也是这个类。<br><strong>Exception</strong>又分为<strong>RunTimeException</strong>和<strong>其他Exception</strong>。</p>
</blockquote>
<h4 id="2-RunTimeException和其他Exception区分："><a href="#2-RunTimeException和其他Exception区分：" class="headerlink" title="2.RunTimeException和其他Exception区分："></a>2.RunTimeException和其他Exception区分：</h4><blockquote>
<p><strong>其他Exception</strong>，受检查异常。可以理解为错误，必须要开发者解决以后才能编译通过，解决的方法有两种，<br>1：throw到上层，<br>2，try-catch处理。</p>
</blockquote>
<blockquote>
<p><strong>RunTimeException</strong>：运行时异常，又称不受检查异常，不受检查！<br>不受检查！！不受检查！！！重要的事情说三遍，因为不受检查，所以在代码中可能会有RunTimeException时Java编译检查时不会告诉你有这个异常，但是在实际运行代码时则会暴露出来，比如经典的1/0，空指针等。如果不处理也会被Java自己处理。</p>
</blockquote>
<h3 id="异常的分类"><a href="#异常的分类" class="headerlink" title="异常的分类"></a>异常的分类</h3><p>Error：一般为底层的不可恢复的类；<br>Exception：分为未检查异常(RuntimeException)和已检查异常(非RuntimeException)。<br>未检查异常是因为程序员没有进行必需要的检查，因为疏忽和错误而引起的错误。几个经典的RunTimeException如下：</p>
<p>1.java.lang.NullPointerException;<br>2.java.lang.ArithmaticException;<br>3.java.lang.ArrayIndexoutofBoundsException</p>
<h4 id="Runtime-Exception："><a href="#Runtime-Exception：" class="headerlink" title="Runtime Exception："></a>Runtime Exception：</h4><p>在定义方法时不需要声明会抛出runtime exception； 在调用这个方法时不需要捕获这个runtime exception； runtime exception是从java.lang.RuntimeException或java.lang.Error类衍生出来的。 例如：nullpointexception，IndexOutOfBoundsException就属于runtime exception</p>
<h4 id="Exception"><a href="#Exception" class="headerlink" title="Exception:"></a>Exception:</h4><p>定义方法时必须声明所有可能会抛出的exception； 在调用这个方法时，必须捕获它的checked exception，不然就得把它的exception传递下去；exception是从java.lang.Exception类衍生出来的。例如：IOException，SQLException就属于Exception</p>
<p>Exception 属于应用程序级别的异常，这类异常必须捕捉,Exception体系包括RuntimeException体系和其他非RuntimeException的体系</p>
<p>RuntimeException 表示系统异常，比较严重，如果出现RuntimeException，那么一定是程序员的错误</p>
<p>什么是unchecked异常?</p>
<p>即RuntimeException（运行时异常）<br>不需要try…catch…或throws 机制去处理的异常</p>
<h3 id="Android异常大全"><a href="#Android异常大全" class="headerlink" title="Android异常大全"></a>Android异常大全</h3><h6 id="java-lang-NullPointerException"><a href="#java-lang-NullPointerException" class="headerlink" title="java.lang.NullPointerException"></a>java.lang.NullPointerException</h6><p>这个异常的解释是 “程序遇上了空指针 “，简单地说就是调用了未经初始化的对象或者是不存在的对象，这个错误经常出现在创建图片，调用数组这些操作中，比如图片未经初始化，或者图片创建时的路径错误等等。对数组操作中出现空指针，即把数组的初始化和数组元素的初始化混淆起来了。数组的初始化是对数组分配需要的空间，而初始化后的数组，其中的元素并没有实例化，依然是空的，所以还需要对每个元素都进行初始化（如果要调用的话）。</p>
<h6 id="java-lang-ClassNotFoundException"><a href="#java-lang-ClassNotFoundException" class="headerlink" title="java.lang.ClassNotFoundException"></a>java.lang.ClassNotFoundException</h6><p>异常的解释是”指定的类不存在”，这里主要考虑一下类的名称和路径是否正确即可</p>
<h6 id="java-lang-ArithmeticException"><a href="#java-lang-ArithmeticException" class="headerlink" title="java.lang.ArithmeticException"></a>java.lang.ArithmeticException</h6><p>这个异常的解释是”数学运算异常”，比如程序中出现了除以零这样的运算就会出这样的异常，对这种异常，大家就要好好检查一下自己程序中涉及到数学运算的地方，公式是不是有不妥了。</p>
<h6 id="java-lang-ArrayIndexOutOfBoundsException"><a href="#java-lang-ArrayIndexOutOfBoundsException" class="headerlink" title="java.lang.ArrayIndexOutOfBoundsException"></a>java.lang.ArrayIndexOutOfBoundsException</h6><p>这个异常的解释是”数组下标越界”，现在程序中大多都有对数组的操作，因此在调用数组的时候一定要认真检查，看自己调用的下标是不是超出了数组的范围，一般来说，显示（即直接用常数当下标）调用不太容易出这样的错，但隐式（即用变量表示下标）调用就经常出错了，还有一种情况，是程序中定义的数组的长度是通过某些特定方法决定的，不是事先声明的，这个时候，最好先查看一下数组的length，以免出现这个异常。</p>
<h6 id="java-lang-IllegalArgumentException"><a href="#java-lang-IllegalArgumentException" class="headerlink" title="java.lang.IllegalArgumentException"></a>java.lang.IllegalArgumentException</h6><p>这个异常的解释是”方法的参数错误”，很多j2me的类库中的方法在一些情况下都会引发这样的错误，比如音量调节方法中的音量参数如果写成负数就会出现这个异常，再比如g.setcolor(int red,int green,int blue)这个方法中的三个值，如果有超过255的也会出现这个异常，因此一旦发现这个异常，我们要做的，就是赶紧去检查一下方法调用中的参数传递是不是出现了错误。</p>
<h6 id="java-lang-IllegalAccessException"><a href="#java-lang-IllegalAccessException" class="headerlink" title="java.lang.IllegalAccessException"></a>java.lang.IllegalAccessException</h6><p>这个异常的解释是”没有访问权限”，当应用程序要调用一个类，但当前的方法即没有对该类的访问权限便会出现这个异常。对程序中用了package的情况下要注意这个异常。<br>其他还有很多异常，我就不一一列举了，我要说明的是，一个合格的程序员，需要对程序中常见的问题有相当的了解和相应的解决办法，否则仅仅停留在写程序而不会改程序的话，会极大影响到自己的开发的。关于异常的全部说明，在api里都可以查阅。</p>
<p>算术异常类：ArithmeticExecption<br>空指针异常类：NullPointerException<br>类型强制转换异常：ClassCastException<br>数组负下标异常：NegativeArrayException<br>数组下标越界异常：ArrayIndexOutOfBoundsException<br>违背安全原则异常：SecturityException<br>文件已结束异常：EOFException<br>文件未找到异常：FileNotFoundException<br>字符串转换为数字异常：NumberFormatException<br>操作数据库异常：SQLException<br>输入输出异常：IOException<br>方法未找到异常：NoSuchMethodException</p>
<h6 id="java-lang-AbstractMethodError"><a href="#java-lang-AbstractMethodError" class="headerlink" title="java.lang.AbstractMethodError"></a>java.lang.AbstractMethodError</h6><p>抽象方法错误。当应用试图调用抽象方法时抛出。</p>
<h6 id="java-lang-AssertionError"><a href="#java-lang-AssertionError" class="headerlink" title="java.lang.AssertionError"></a>java.lang.AssertionError</h6><p>断言错。用来指示一个断言失败的情况。</p>
<h6 id="java-lang-ClassCircularityError"><a href="#java-lang-ClassCircularityError" class="headerlink" title="java.lang.ClassCircularityError"></a>java.lang.ClassCircularityError</h6><p>类循环依赖错误。在初始化一个类时，若检测到类之间循环依赖则抛出该异常。</p>
<h6 id="java-lang-ClassFormatError"><a href="#java-lang-ClassFormatError" class="headerlink" title="java.lang.ClassFormatError"></a>java.lang.ClassFormatError</h6><p>类格式错误。当Java虚拟机试图从一个文件中读取Java类，而检测到该文件的内容不符合类的有效格式时抛出。</p>
<h6 id="java-lang-Error"><a href="#java-lang-Error" class="headerlink" title="java.lang.Error"></a>java.lang.Error</h6><p>错误。是所有错误的基类，用于标识严重的程序运行问题。这些问题通常描述一些不应被应用程序捕获的反常情况。</p>
<h6 id="java-lang-ExceptionInInitializerError"><a href="#java-lang-ExceptionInInitializerError" class="headerlink" title="java.lang.ExceptionInInitializerError"></a>java.lang.ExceptionInInitializerError</h6><p>初始化程序错误。当执行一个类的静态初始化程序的过程中，发生了异常时抛出。静态初始化程序是指直接包含于类中的static语句段。</p>
<h6 id="java-lang-IllegalAccessError"><a href="#java-lang-IllegalAccessError" class="headerlink" title="java.lang.IllegalAccessError"></a>java.lang.IllegalAccessError</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">违法访问错误。当一个应用试图访问、修改某个类的域（Field）或者调用其方法，但是又违反域或方法的可见性声明，则抛出该异常。</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h6 id="java-lang-IncompatibleClassChangeError"><a href="#java-lang-IncompatibleClassChangeError" class="headerlink" title="java.lang.IncompatibleClassChangeError"></a>java.lang.IncompatibleClassChangeError</h6><p>不兼容的类变化错误。当正在执行的方法所依赖的类定义发生了不兼容的改变时，抛出该异常。一般在修改了应用中的某些类的声明定义而没有对整个应用重新编译而直接运行的情况下，容易引发该错误。</p>
<h6 id="java-lang-InstantiationError"><a href="#java-lang-InstantiationError" class="headerlink" title="java.lang.InstantiationError"></a>java.lang.InstantiationError</h6><p>实例化错误。当一个应用试图通过Java的new操作符构造一个抽象类或者接口时抛出该异常.</p>
<h6 id="java-lang-InternalError"><a href="#java-lang-InternalError" class="headerlink" title="java.lang.InternalError"></a>java.lang.InternalError</h6><p>内部错误。用于指示Java虚拟机发生了内部错误。</p>
<h6 id="java-lang-LinkageError"><a href="#java-lang-LinkageError" class="headerlink" title="java.lang.LinkageError"></a>java.lang.LinkageError</h6><p>链接错误。该错误及其所有子类指示某个类依赖于另外一些类，在该类编译之后，被依赖的类改变了其类定义而没有重新编译所有的类，进而引发错误的情况。</p>
<h6 id="java-lang-NoClassDefFoundError"><a href="#java-lang-NoClassDefFoundError" class="headerlink" title="java.lang.NoClassDefFoundError"></a>java.lang.NoClassDefFoundError</h6><p>未找到类定义错误。当Java虚拟机或者类装载器试图实例化某个类，而找不到该类的定义时抛出该错误。</p>
<h6 id="java-lang-NoSuchFieldError"><a href="#java-lang-NoSuchFieldError" class="headerlink" title="java.lang.NoSuchFieldError"></a>java.lang.NoSuchFieldError</h6><p>域不存在错误。当应用试图访问或者修改某类的某个域，而该类的定义中没有该域的定义时抛出该错误。</p>
<h6 id="java-lang-NoSuchMethodError"><a href="#java-lang-NoSuchMethodError" class="headerlink" title="java.lang.NoSuchMethodError"></a>java.lang.NoSuchMethodError</h6><p>方法不存在错误。当应用试图调用某类的某个方法，而该类的定义中没有该方法的定义时抛出该错误。</p>
<h6 id="java-lang-OutOfMemoryError"><a href="#java-lang-OutOfMemoryError" class="headerlink" title="java.lang.OutOfMemoryError"></a>java.lang.OutOfMemoryError</h6><p>内存不足错误。当可用内存不足以让Java虚拟机分配给一个对象时抛出该错误。</p>
<h6 id="java-lang-StackOverflowError"><a href="#java-lang-StackOverflowError" class="headerlink" title="java.lang.StackOverflowError"></a>java.lang.StackOverflowError</h6><p>堆栈溢出错误。当一个应用递归调用的层次太深而导致堆栈溢出时抛出该错误。</p>
<h6 id="java-lang-ThreadDeath"><a href="#java-lang-ThreadDeath" class="headerlink" title="java.lang.ThreadDeath"></a>java.lang.ThreadDeath</h6><p>线程结束。当调用Thread类的stop方法时抛出该错误，用于指示线程结束。</p>
<h6 id="java-lang-UnknownError"><a href="#java-lang-UnknownError" class="headerlink" title="java.lang.UnknownError"></a>java.lang.UnknownError</h6><p>未知错误。用于指示Java虚拟机发生了未知严重错误的情况。</p>
<h6 id="java-lang-UnsatisfiedLinkError"><a href="#java-lang-UnsatisfiedLinkError" class="headerlink" title="java.lang.UnsatisfiedLinkError"></a>java.lang.UnsatisfiedLinkError</h6><p>未满足的链接错误。当Java虚拟机未找到某个类的声明为native方法的本机语言定义时抛出。</p>
<h6 id="java-lang-UnsupportedClassVersionError"><a href="#java-lang-UnsupportedClassVersionError" class="headerlink" title="java.lang.UnsupportedClassVersionError"></a>java.lang.UnsupportedClassVersionError</h6><p>不支持的类版本错误。当Java虚拟机试图从读取某个类文件，但是发现该文件的主、次版本号不被当前Java虚拟机支持的时候，抛出该错误。</p>
<h6 id="java-lang-VerifyError"><a href="#java-lang-VerifyError" class="headerlink" title="java.lang.VerifyError"></a>java.lang.VerifyError</h6><p>验证错误。当验证器检测到某个类文件中存在内部不兼容或者安全问题时抛出该错误。</p>
<h6 id="java-lang-VirtualMachineError"><a href="#java-lang-VirtualMachineError" class="headerlink" title="java.lang.VirtualMachineError"></a>java.lang.VirtualMachineError</h6><p>虚拟机错误。用于指示虚拟机被破坏或者继续执行操作所需的资源不足的情况。</p>
<h6 id="java-lang-ArithmeticException-1"><a href="#java-lang-ArithmeticException-1" class="headerlink" title="java.lang.ArithmeticException"></a>java.lang.ArithmeticException</h6><p>算术条件异常。譬如：整数除零等。</p>
<h6 id="java-lang-ArrayIndexOutOfBoundsException-1"><a href="#java-lang-ArrayIndexOutOfBoundsException-1" class="headerlink" title="java.lang.ArrayIndexOutOfBoundsException"></a>java.lang.ArrayIndexOutOfBoundsException</h6><p>数组索引越界异常。当对数组的索引值为负数或大于等于数组大小时抛出。</p>
<h6 id="java-lang-ArrayStoreException"><a href="#java-lang-ArrayStoreException" class="headerlink" title="java.lang.ArrayStoreException"></a>java.lang.ArrayStoreException</h6><p>数组存储异常。当向数组中存放非数组声明类型对象时抛出。</p>
<h6 id="java-lang-ClassCastException"><a href="#java-lang-ClassCastException" class="headerlink" title="java.lang.ClassCastException"></a>java.lang.ClassCastException</h6><p>类造型异常。假设有类A和B（A不是B的父类或子类），O是A的实例，那么当强制将O构造为类B的实例时抛出该异常。该异常经常被称为强制类型转换异常。</p>
<h6 id="java-lang-ClassNotFoundException-1"><a href="#java-lang-ClassNotFoundException-1" class="headerlink" title="java.lang.ClassNotFoundException"></a>java.lang.ClassNotFoundException</h6><p>找不到类异常。当应用试图根据字符串形式的类名构造类，而在遍历 CLASSPAH之后找不到对应名称的class文件时，抛出该异常。</p>
<h6 id="java-lang-CloneNotSupportedException"><a href="#java-lang-CloneNotSupportedException" class="headerlink" title="java.lang.CloneNotSupportedException"></a>java.lang.CloneNotSupportedException</h6><p>不支持克隆异常。当没有实现Cloneable接口或者不支持克隆方法时,调用其clone()方法则抛出该异常。</p>
<h6 id="java-lang-EnumConstantNotPresentException"><a href="#java-lang-EnumConstantNotPresentException" class="headerlink" title="java.lang.EnumConstantNotPresentException"></a>java.lang.EnumConstantNotPresentException</h6><p>枚举常量不存在异常。当应用试图通过名称和枚举类型访问一个枚举对象，但该枚举对象并不包含常量时，抛出该异常。</p>
<h6 id="java-lang-Exception"><a href="#java-lang-Exception" class="headerlink" title="java.lang.Exception"></a>java.lang.Exception</h6><p>根异常。用以描述应用程序希望捕获的情况。</p>
<h6 id="java-lang-IllegalAccessException-1"><a href="#java-lang-IllegalAccessException-1" class="headerlink" title="java.lang.IllegalAccessException"></a>java.lang.IllegalAccessException</h6><p>违法的访问异常。当应用试图通过反射方式创建某个类的实例、访问该类属性、调用该类方法，而当时又无法访问类的、属性的、方法的或构造方法的定义时抛出该异常。</p>
<h6 id="java-lang-IllegalMonitorStateException"><a href="#java-lang-IllegalMonitorStateException" class="headerlink" title="java.lang.IllegalMonitorStateException"></a>java.lang.IllegalMonitorStateException</h6><p>违法的监控状态异常。当某个线程试图等待一个自己并不拥有的对象（O）的监控器或者通知其他线程等待该对象（O）的监控器时，抛出该异常。</p>
<h6 id="java-lang-IllegalStateException"><a href="#java-lang-IllegalStateException" class="headerlink" title="java.lang.IllegalStateException"></a>java.lang.IllegalStateException</h6><p>违法的状态异常。当在Java环境和应用尚未处于某个方法的合法调用状态，而调用了该方法时，抛出该异常。</p>
<h6 id="java-lang-IllegalThreadStateException"><a href="#java-lang-IllegalThreadStateException" class="headerlink" title="java.lang.IllegalThreadStateException"></a>java.lang.IllegalThreadStateException</h6><p>违法的线程状态异常。当县城尚未处于某个方法的合法调用状态，而调用了该方法时，抛出异常。</p>
<h6 id="java-lang-IndexOutOfBoundsException"><a href="#java-lang-IndexOutOfBoundsException" class="headerlink" title="java.lang.IndexOutOfBoundsException"></a>java.lang.IndexOutOfBoundsException</h6><p>索引越界异常。当访问某个序列的索引值小于0或大于等于序列大小时，抛出该异常。</p>
<h6 id="java-lang-InstantiationException"><a href="#java-lang-InstantiationException" class="headerlink" title="java.lang.InstantiationException"></a>java.lang.InstantiationException</h6><p>实例化异常。当试图通过 newInstance()方法创建某个类的实例，而该类是一个抽象类或接口时，抛出该异常。</p>
<h6 id="java-lang-InterruptedException"><a href="#java-lang-InterruptedException" class="headerlink" title="java.lang.InterruptedException"></a>java.lang.InterruptedException</h6><p>被中止异常。当某个线程处于长时间的等待、休眠或其他暂停状态，而此时其他的线程通过Thread的###### interrupt方法终止该线程时抛出该异常。</p>
<h6 id="java-lang-NegativeArraySizeException"><a href="#java-lang-NegativeArraySizeException" class="headerlink" title="java.lang.NegativeArraySizeException"></a>java.lang.NegativeArraySizeException</h6><p>数组大小为负值异常。当使用负数大小值创建数组时抛出该异常。</p>
<h6 id="java-lang-NoSuchFieldException"><a href="#java-lang-NoSuchFieldException" class="headerlink" title="java.lang.NoSuchFieldException"></a>java.lang.NoSuchFieldException</h6><p>属性不存在异常。当访问某个类的不存在的属性时抛出该异常。</p>
<h6 id="java-lang-NoSuchMethodException"><a href="#java-lang-NoSuchMethodException" class="headerlink" title="java.lang.NoSuchMethodException"></a>java.lang.NoSuchMethodException</h6><p>方法不存在异常。当访问某个类的不存在的方法时抛出该异常。</p>
<h6 id="java-lang-NullPointerException-1"><a href="#java-lang-NullPointerException-1" class="headerlink" title="java.lang.NullPointerException"></a>java.lang.NullPointerException</h6><p>空指针异常。当应用试图在要求使用对象的地方使用了 null时，抛出该异常。譬如：调用null对象的实例方法、访问null对象的属性、计算null对象的长度、使用throw语句抛出null等等。</p>
<h6 id="java-lang-NumberFormatException"><a href="#java-lang-NumberFormatException" class="headerlink" title="java.lang.NumberFormatException"></a>java.lang.NumberFormatException</h6><p>数字格式异常。当试图将一个String转换为指定的数字类型，而该字符串确不满足数字类型要求的格式时，抛出该异常。</p>
<h6 id="java-lang-RuntimeException"><a href="#java-lang-RuntimeException" class="headerlink" title="java.lang.RuntimeException"></a>java.lang.RuntimeException</h6><p>运行时异常。是所有 Java虚拟机正常操作期间可以被抛出的异常的父类。</p>
<h6 id="java-lang-SecurityException"><a href="#java-lang-SecurityException" class="headerlink" title="java.lang.SecurityException"></a>java.lang.SecurityException</h6><p>安全异常。由安全管理器抛出，用于指示违反安全情况的异常。</p>
<h6 id="java-lang-StringIndexOutOfBoundsException"><a href="#java-lang-StringIndexOutOfBoundsException" class="headerlink" title="java.lang.StringIndexOutOfBoundsException"></a>java.lang.StringIndexOutOfBoundsException</h6><p>字符串索引越界异常。当使用索引值访问某个字符串中的字符，而该索引值小于0或大于等于序列大小时，抛出该异常。</p>
<h6 id="java-lang-TypeNotPresentException"><a href="#java-lang-TypeNotPresentException" class="headerlink" title="java.lang.TypeNotPresentException"></a>java.lang.TypeNotPresentException</h6><p>类型不存在异常。当应用试图</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/09/Spark-%E6%99%AE%E9%80%9A%E6%96%87%E4%BB%B6%E5%A4%9A%E8%B7%AF%E8%BE%93%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/09/Spark-%E6%99%AE%E9%80%9A%E6%96%87%E4%BB%B6%E5%A4%9A%E8%B7%AF%E8%BE%93%E5%87%BA/" itemprop="url">Spark saveAsHadoopFile 文件多路输出</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-09T20:42:25+08:00">
                2020-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h6 id="RDD-collect-："><a href="#RDD-collect-：" class="headerlink" title="RDD.collect()："></a>RDD.collect()：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;_1&quot;:&quot;a&quot;,</span><br><span class="line">		&quot;_2&quot;:&quot;this is a record&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;_1&quot;:&quot;b&quot;,</span><br><span class="line">		&quot;_2&quot;:&quot;this is b record&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;_1&quot;:&quot;c&quot;,</span><br><span class="line">		&quot;_2&quot;:&quot;this is c record&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;_1&quot;:&quot;e&quot;,</span><br><span class="line">		&quot;_2&quot;:&quot;this is d record&quot;</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h6 id="自定义多路输出类："><a href="#自定义多路输出类：" class="headerlink" title="自定义多路输出类："></a>自定义多路输出类：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.hadoop.mapred.lib.MultipleTextOutputFormat;</span><br><span class="line"></span><br><span class="line">public class RDDMultipleTextOutputFormat extends MultipleTextOutputFormat&lt;String, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected String generateFileNameForKeyValue(String key, String value, String name) &#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">        name &#x3D; key + &quot;&#x2F;&quot; + name;</span><br><span class="line">        return  name; &#x2F;&#x2F; &quot;a&#x2F;part&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h6 id="保存文件（rdd-saveAsHadoopFile）："><a href="#保存文件（rdd-saveAsHadoopFile）：" class="headerlink" title="保存文件（rdd.saveAsHadoopFile）："></a>保存文件（rdd.saveAsHadoopFile）：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdd.saveAsHadoopFile(path, String.class, String.class, RDDMultipleTextOutputFormat.class);</span><br></pre></td></tr></table></figure>

<h6 id="输出结果"><a href="#输出结果" class="headerlink" title="输出结果"></a>输出结果</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$hadoop fs -ls &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;</span><br><span class="line">Found 5 items</span><br><span class="line">-rw-rw-r--   3 shouyan.li work          0 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;_SUCCESS</span><br><span class="line">drwxrwxr-x   - shouyan.li work          0 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;a</span><br><span class="line">drwxrwxr-x   - shouyan.li work          0 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;b</span><br><span class="line">drwxrwxr-x   - shouyan.li work          0 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;c</span><br><span class="line">drwxrwxr-x   - shouyan.li work          0 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;e</span><br><span class="line"></span><br><span class="line">$ hadoop fs -ls &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;a</span><br><span class="line">Found 1 items</span><br><span class="line">-rw-rw-r--   3 shouyan.li work         24 2020-12-09 20:27 &#x2F;user&#x2F;shouyan.li&#x2F;freq&#x2F;a&#x2F;part-00000</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/09/Spark-%E5%A4%9A%E8%B7%AF%E8%BE%93%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thousandth of Dirt">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/09/Spark-%E5%A4%9A%E8%B7%AF%E8%BE%93%E5%87%BA/" itemprop="url">Spark中Dataset Schema分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-09T16:37:36+08:00">
                2020-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spark中Dataset Schema分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Console.log(rowstr);</span><br><span class="line">&#123;</span><br><span class="line">	&quot;freq&quot;:1,</span><br><span class="line">	&quot;text&quot;:&quot;a&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ds.schema();</span><br><span class="line">&#123;</span><br><span class="line">	&quot;empty&quot;:false,</span><br><span class="line">	&quot;traversableAgain&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ds.schema().toString();</span><br><span class="line">StructType(</span><br><span class="line">	StructField(freq,LongType,true), </span><br><span class="line">    StructField(text,StringType,true)</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ds.printSchema();</span><br><span class="line">root</span><br><span class="line"> |-- freq: long (nullable &#x3D; true)</span><br><span class="line"> |-- text: string (nullable &#x3D; true)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Configuration conf &#x3D; new Configuration();</span><br><span class="line">conf.set(&quot;parquet.write.support.class&quot;, GroupWriteSupport.class.getName());</span><br><span class="line">conf.set(&quot;spark.sql.parquet.writeLegacyFormat&quot;, &quot;false&quot;);</span><br><span class="line">conf.set(&quot;spark.sql.parquet.outputTimestampType&quot;, &quot;INT96&quot;);</span><br><span class="line">conf.set(&quot;parquet.enable.dictionary&quot;, &quot;false&quot;);</span><br><span class="line">conf.set(&quot;parquet.compression&quot;, &quot;snappy&quot;);</span><br><span class="line">MessageType mt &#x3D; new SparkToParquetSchemaConverter(configuration).convert(ds.schema());</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;columns&quot;:[</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;maxDefinitionLevel&quot;:1,</span><br><span class="line">			&quot;maxRepetitionLevel&quot;:0,</span><br><span class="line">			&quot;path&quot;:[&quot;freq&quot;],</span><br><span class="line">			&quot;type&quot;:&quot;INT64&quot;,</span><br><span class="line">			&quot;typeLength&quot;:0</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;maxDefinitionLevel&quot;:1,</span><br><span class="line">			&quot;maxRepetitionLevel&quot;:0,</span><br><span class="line">			&quot;path&quot;:[&quot;text&quot;],</span><br><span class="line">			&quot;type&quot;:&quot;BINARY&quot;,</span><br><span class="line">			&quot;typeLength&quot;:0</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;fieldCount&quot;:2,</span><br><span class="line">	&quot;fields&quot;:[</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;decimalMetadata&quot;:null,</span><br><span class="line">			&quot;id&quot;:null,</span><br><span class="line">			&quot;name&quot;:&quot;freq&quot;,</span><br><span class="line">			&quot;originalType&quot;:null,</span><br><span class="line">			&quot;primitive&quot;:true,</span><br><span class="line">			&quot;primitiveTypeName&quot;:&quot;INT64&quot;,</span><br><span class="line">			&quot;repetition&quot;:&quot;OPTIONAL&quot;,</span><br><span class="line">			&quot;typeLength&quot;:0</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;decimalMetadata&quot;:null,</span><br><span class="line">			&quot;id&quot;:null,</span><br><span class="line">			&quot;name&quot;:&quot;text&quot;,</span><br><span class="line">			&quot;originalType&quot;:&quot;UTF8&quot;,</span><br><span class="line">			&quot;primitive&quot;:true,</span><br><span class="line">			&quot;primitiveTypeName&quot;:&quot;BINARY&quot;,</span><br><span class="line">			&quot;repetition&quot;:&quot;OPTIONAL&quot;,</span><br><span class="line">			&quot;typeLength&quot;:0</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;id&quot;:null,</span><br><span class="line">	&quot;name&quot;:&quot;spark_schema&quot;,</span><br><span class="line">	&quot;originalType&quot;:null,</span><br><span class="line">	&quot;paths&quot;:[</span><br><span class="line">		[&quot;freq&quot;],</span><br><span class="line">		[&quot;text&quot;]</span><br><span class="line">	],</span><br><span class="line">	&quot;primitive&quot;:false,</span><br><span class="line">	&quot;repetition&quot;:&quot;REPEATED&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt.toString();</span><br><span class="line">&quot;message spark_schema &#123;\n  optional int64 freq;\n  optional binary text (UTF8);\n&#125;\n&quot;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
